<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Cartidle - Guess the Playboi Carti Song</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="shortcut icon" href="favicon.png" type="image/png">
  <link rel="stylesheet" type="text/css" media="screen" href="styl.css">
</head>
<style>

</style>
<body>
  <!-- Kontener z ikonkami w prawym górnym rogu -->
  <div id="iconsContainer">
    <img id="infoIcon" src="info.png" alt="Info Icon">
    <img id="donateIcon" src="donateicon.png" alt="Donate Icon">
  </div>
<body>
  <img src="napis.png" class="napis">
  <div id="container">
    <p><b>Guess the Playboi Carti song</b></p>
    <input type="text" id="guessInput" placeholder="Enter a song title" oninput="showSuggestions()" />
    <ul id="suggestionsList"></ul>
    <button id="guessButton">Guess</button><br>
    <button id="showResultsButton">Show Results</button>
    <div id="result"></div>
  </div>
  
  <div class="tabela">
    <table>
      <thead>
        <tr>
          <th>Song</th>
          <th>Album</th>
          <th>Track No.</th>
          <th>Track Length</th>
          <th>Features</th>
        </tr>
      </thead>
      <tbody id="guessesTable"></tbody>
    </table>
  </div>





  <!-- Modal końcowy -->
  <div id="endGameModal" class="modal-wrapper">
    <div class="modal-content" id="endGameContent">
      <h1 id="endGameTitle">Game Over!</h1>
      <img id="albumCover" src="" alt="Album Cover">
      <p id="finalSongName"></p>
      <p id="finalFeatures"></p>
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-label">GAMES PLAYED</div>
          <div class="stat-square"><span id="gamesPlayed">0</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">CORRECT GUESSES</div>
          <div class="stat-square"><span id="correctGuesses">0</span></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">WIN STREAK</div>
          <div class="stat-square"><span id="winStreak">0</span></div>
        </div>
        <div class="stat-best">
          <div class="stat-label">BEST WIN STREAK</div>
          <div class="stat-square"><span id="bestWinStreak">0</span></div>
        </div>
      </div>
      <div class="album-divider">
        <div class="marquee">
          <img src="photo/wholelottared.jpg" alt="Album 1">
          <img src="photo/dieeelittt.jpg" alt="Album 2">
          <img src="photo/selftitled.jpg" alt="Album 3">
        </div>
      </div>
      <div id="donationContainer">
        <p style="margin-top: 10px;">
          Consider donating to help keep this running! 
          <span style="color: red;">❤️</span>
        </p>
        <button id="supportUsButton">Support us!</button>
      </div>
    </div>
  </div>
  
  <!-- Modal powitalny -->
  <div id="welcomeModal" class="modal-wrapper">
    <div class="modal-content" id="welcomeContent">
      <h1>Welcome to Cartidle!</h1>
    </div>
  </div>
  
  <!-- Modal z instrukcjami -->
  <div id="instructionsModal" class="modal-wrapper">
    <div class="modal-content" id="instructionsContent">
      <h2 id="startList">Few things before you start</h2>
      <div id="albumImages" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
        <img src="photo/wholelottared.jpg" alt="Album Whole Lotta Red" style="width: 80px; height: auto;">
        <img src="photo/dieeelittt.jpg" alt="Album Dieeelittt" style="width: 80px; height: auto;">
        <img src="photo/selftitled.jpg" alt="Album Selftitled" style="width: 80px; height: auto;">
      </div>
      <ul id="instructionsList">
        <li>You have eight attempts to guess any Playboi Carti song.</li>
        <li>If the column is <span class="highlight-green">green</span> it means you have found the perfect connection!</li>
        <li>If there is a <span class="highlight-yellow">yellow</span> colour in the Album or Track No. column, it means that within 1 album or track with an arrow indicating whether it is higher ∧ or lower ∨.</li>
        <li>But if the colour in the track length column is <span class="highlight-yellow">yellow</span>, it means that the track is within 15 seconds with an arrow indicating whether it is higher ∧ or lower ∨.</li>
        <li>If the features column is <span class="highlight-yellow">yellow</span>, it means that this artist is correct but is on a different song.</li>
        <p id="finalMessage">Good Luck Have Fun!</p>
      </ul>
    </div>
  </div>
  
  <footer style="position: fixed; bottom: 10px; left: 10px; color: white;">
    <h2>Inspired by <a href="https://yeezle.xyz" style="color: #e50914; text-decoration: none;">YEEZLE</a></h2>
  </footer>
  
  <script>
    // Funkcje do obsługi ciasteczek
    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      var expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }
    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(name) === 0) return c.substring(name.length, c.length);
      }
      return "";
    }
    
  // Modify the existing cookie handling and modal display code
  document.addEventListener('DOMContentLoaded', function() {
  // Check if user has seen the modals before
  if(getCookie("modalsShown") === "true") {
    // If user has seen modals, hide them immediately
    document.getElementById('welcomeModal').style.display = 'none';
    document.getElementById('instructionsModal').style.display = 'none';
  } else {
    // If it's the first visit, show the welcome modal
    document.getElementById('welcomeModal').style.display = 'flex';
    document.getElementById('instructionsModal').style.display = 'none';
    
    // Add event listener to welcome modal to transition to instructions
    document.getElementById('welcomeModal').addEventListener('click', function() {
      transitionToInstructions();
    });
    
    // Add event listener to instructions modal to close and set cookie
    document.getElementById('instructionsModal').addEventListener('click', function(event) {
      const modalContent = this.querySelector('.modal-content');
      if (!modalContent.contains(event.target)) {
        this.style.opacity = 0;
        setTimeout(() => {
          this.style.display = 'none';
          this.style.opacity = 1;
          // Set cookie when user closes the instructions modal
          setCookie("modalsShown", "true", 365);
        }, 500);
      }
    });
  }
});

// Function to transition from welcome modal to instructions
function transitionToInstructions() {
  const welcomeModal = document.getElementById('welcomeModal');
  const instructionsModal = document.getElementById('instructionsModal');
  welcomeModal.style.opacity = 0;
  setTimeout(() => {
    welcomeModal.style.display = 'none';
    instructionsModal.style.display = 'flex';
    instructionsModal.style.opacity = 0;
    void instructionsModal.offsetWidth;
    instructionsModal.style.transition = 'opacity 0.5s ease-out';
    instructionsModal.style.opacity = 1;
    // Note: We don't set the cookie here anymore - only after the instructions are closed
  }, 500);
}

    function saveStats() {
  const stats = {
    totalGames: totalGames,
    totalCorrect: totalCorrect,
    currentWinStreak: currentWinStreak,
    bestWinStreak: bestWinStreak
  };
  localStorage.setItem("cartidle_playerStats", JSON.stringify(stats));
}

function loadStats() {
  const statsData = localStorage.getItem("cartidle_playerStats");
  if (statsData) {
    try {
      const stats = JSON.parse(statsData);
      totalGames = stats.totalGames || 0;
      totalCorrect = stats.totalCorrect || 0;
      currentWinStreak = stats.currentWinStreak || 0;
      bestWinStreak = stats.bestWinStreak || 0;
    } catch (e) {
      console.error("Error parsing stats data:", e);
      // Reset stats if there's an error
      totalGames = 0;
      totalCorrect = 0;
      currentWinStreak = 0;
      bestWinStreak = 0;
    }
  }
}
function hasPlayedToday() {
  const lastPlayedDate = localStorage.getItem("cartidle_lastPlayedDate");
  if (!lastPlayedDate) return false;
  
  const today = new Date().toDateString();
  return lastPlayedDate === today;
}
    // Function to mark that player played today
function markPlayedToday() {
  const today = new Date().toDateString();
  localStorage.setItem("cartidle_lastPlayedDate", today);
}

// Function to check if it's a new song period
function isNewSongPeriod() {
  const lastSongPeriod = localStorage.getItem("cartidle_lastSongPeriod");
  if (!lastSongPeriod) return true;
  
  return parseInt(lastSongPeriod) !== periodIndex;
}

// Function to save current song period
function saveSongPeriod() {
  localStorage.setItem("cartidle_lastSongPeriod", periodIndex.toString());
}

// Modify the document load event to initialize the game based on stored data
window.addEventListener('DOMContentLoaded', function() {
  // Load saved statistics
  loadStats();
  
  // Update stats display if they're on the page
  updateStatsDisplay();
  
  // Check if modals should be shown
  if(getCookie("modalsShown") === "true") {
    document.getElementById('welcomeModal').style.display = 'none';
    document.getElementById('instructionsModal').style.display = 'none';
  }
  
  // Check if player already completed today's challenge
  if (hasPlayedToday() && !isNewSongPeriod()) {
    // Disable input and show results
    document.getElementById('guessInput').disabled = true;
    document.getElementById('guessButton').style.display = "none";
    document.getElementById('showResultsButton').style.display = "block";
    
    // Show previous guesses if available
    const savedGuesses = localStorage.getItem("cartidle_todayGuesses");
    if (savedGuesses) {
      try {
        const guesses = JSON.parse(savedGuesses);
        guessedSongs = guesses.songs || [];
        attempts = guesses.attempts || 0;
        isGameOver = guesses.isGameOver || false;
        
        // Rebuild the guesses table
        rebuildGuessesTable(guesses.tableData || []);
      } catch (e) {
        console.error("Error parsing saved guesses:", e);
      }
    }
  } else if (isNewSongPeriod()) {
    // Clear previous game data for new song
    localStorage.removeItem("cartidle_todayGuesses");
  }
});

// Function to update stats display elements
function updateStatsDisplay() {
  // Update stats in any visible areas
  const winStreakElems = document.querySelectorAll('[id="winStreak"]');
  const correctGuessesElems = document.querySelectorAll('[id="correctGuesses"]');
  const gamesPlayedElems = document.querySelectorAll('[id="gamesPlayed"]');
  const bestWinStreakElems = document.querySelectorAll('[id="bestWinStreak"]');
  
  winStreakElems.forEach(elem => { elem.textContent = currentWinStreak; });
  correctGuessesElems.forEach(elem => { elem.textContent = totalCorrect; });
  gamesPlayedElems.forEach(elem => { elem.textContent = totalGames; });
  bestWinStreakElems.forEach(elem => { elem.textContent = bestWinStreak; });
}

// Function to save current game progress
function saveGameProgress() {
  const tableData = [];
  const rows = document.getElementById('guessesTable').querySelectorAll('tr');
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 5) {
      const rowData = {
        song: cells[0].textContent,
        album: cells[1].querySelector('img')?.src.split('/').pop() || '',
        trackNo: cells[2].textContent,
        trackLength: cells[3].textContent,
        features: cells[4].textContent,
        cellClasses: [
          [...cells[0].classList],
          [...cells[1].classList],
          [...cells[2].classList],
          [...cells[3].classList],
          [...cells[4].classList]
        ]
      };
      tableData.push(rowData);
    }
  });
  
  const gameData = {
    songs: guessedSongs,
    attempts: attempts,
    isGameOver: isGameOver,
    tableData: tableData
  };
  
  localStorage.setItem("cartidle_todayGuesses", JSON.stringify(gameData));
  markPlayedToday();
  saveSongPeriod();
}

// Function to rebuild guesses table from saved data
function rebuildGuessesTable(tableData) {
  const guessesTable = document.getElementById('guessesTable');
  guessesTable.innerHTML = '';
  
  tableData.forEach(rowData => {
    const newRow = document.createElement('tr');
    
    // Create cells
    const songCell = document.createElement('td');
    songCell.textContent = rowData.song;
    rowData.cellClasses[0].forEach(cls => songCell.classList.add(cls));
    
    const albumCell = document.createElement('td');
    albumCell.classList.add('album-cell');
    rowData.cellClasses[1].forEach(cls => albumCell.classList.add(cls));
    
    const albumContainer = document.createElement('div');
    albumContainer.classList.add('album-container');
    albumContainer.style.width = '100%';
    
    const albumImg = document.createElement('img');
    albumImg.src = `photo/${rowData.album}`;
    albumImg.alt = rowData.album;
    albumImg.classList.add('album-image');
    albumImg.style.marginRight = "10px";
    albumContainer.appendChild(albumImg);
    
    // Check if we need to add arrow
    if (rowData.cellClasses[1].includes('neighbor')) {
      const arrowSpan = document.createElement('span');
      if (rowData.cellClasses[1].includes('arrow-up')) {
        arrowSpan.classList.add('arrow-up');
      } else if (rowData.cellClasses[1].includes('arrow-down')) {
        arrowSpan.classList.add('arrow-down');
      }
      arrowSpan.style.width = "15px";
      arrowSpan.style.display = "inline-block";
      arrowSpan.style.textAlign = "right";
      albumContainer.appendChild(arrowSpan);
    }
    
    albumCell.appendChild(albumContainer);
    
    const trackNoCell = document.createElement('td');
    trackNoCell.textContent = rowData.trackNo;
    rowData.cellClasses[2].forEach(cls => trackNoCell.classList.add(cls));
    
    const trackLengthCell = document.createElement('td');
    trackLengthCell.textContent = rowData.trackLength;
    rowData.cellClasses[3].forEach(cls => trackLengthCell.classList.add(cls));
    
    const featuresCell = document.createElement('td');
    featuresCell.textContent = rowData.features;
    rowData.cellClasses[4].forEach(cls => featuresCell.classList.add(cls));
    
    // Append cells to row
    newRow.appendChild(songCell);
    newRow.appendChild(albumCell);
    newRow.appendChild(trackNoCell);
    newRow.appendChild(trackLengthCell);
    newRow.appendChild(featuresCell);
    
    // Append row to table
    guessesTable.appendChild(newRow);
  });
}

// Modify guessButton click handler to save progress after each guess
document.getElementById('guessButton').addEventListener('click', () => {
  if (attempts >= maxAttempts || isGameOver) return;
  const userGuess = document.getElementById('guessInput').value.trim();
  const guessedSong = songsDatabase.find(song => song.song.toLowerCase() === userGuess.toLowerCase());
  if (guessedSong && !guessedSongs.includes(guessedSong.song)) {
    attempts++;
    guessedSongs.push(guessedSong.song);

    const newRow = document.createElement('tr');
    const songCell = document.createElement('td');
    const albumCell = document.createElement('td');
    const trackNoCell = document.createElement('td');
    const trackLengthCell = document.createElement('td');
    const featuresCell = document.createElement('td');

    songCell.textContent = guessedSong.song;

    const albumContainer = document.createElement('div');
    albumContainer.classList.add('album-container');
    albumContainer.style.width = '100%';

    const albumImg = document.createElement('img');
    albumImg.src = `photo/${guessedSong.album}`;
    albumImg.alt = guessedSong.album;
    albumImg.classList.add('album-image');
    albumImg.style.marginRight = "10px";
    albumContainer.appendChild(albumImg);

    if (guessedSong.album !== randomSong.album) {
      const arrowSpan = document.createElement('span');
      if (albumReleaseYears[guessedSong.album] < albumReleaseYears[randomSong.album]) {
        arrowSpan.classList.add('arrow-up');
      } else {
        arrowSpan.classList.add('arrow-down');
      }
      arrowSpan.style.width = "15px";
      arrowSpan.style.display = "inline-block";
      arrowSpan.style.textAlign = "right";
      albumContainer.appendChild(arrowSpan);
    }

    albumCell.appendChild(albumContainer);
    albumCell.classList.add('album-cell');

    trackNoCell.textContent = guessedSong.trackNo;
    trackLengthCell.textContent = guessedSong.trackLength;
    featuresCell.textContent = guessedSong.features;

    highlightCell(songCell, guessedSong.song === randomSong.song, true);
    highlightCell(albumCell, guessedSong.album === randomSong.album);
    highlightNumericCell(trackNoCell, guessedSong.trackNo, randomSong.trackNo);
    highlightTimeCell(trackLengthCell, guessedSong.trackLength, randomSong.trackLength);
    highlightCell(featuresCell, guessedSong.features === randomSong.features);

    newRow.appendChild(songCell);
    newRow.appendChild(albumCell);
    newRow.appendChild(trackNoCell);
    newRow.appendChild(trackLengthCell);
    newRow.appendChild(featuresCell);

    newRow.classList.add('fade-in');
    document.getElementById('guessesTable').appendChild(newRow);

    if (guessedSong.song === randomSong.song) {
      isGameOver = true;
      totalGames++;
      totalCorrect++;
      currentWinStreak++;
      if (currentWinStreak > bestWinStreak) {
        bestWinStreak = currentWinStreak;
      }
      saveStats();
      saveGameProgress();
      showEndGameModal(true);
      document.getElementById('guessButton').style.display = "none";
      document.getElementById('showResultsButton').style.display = "block";
    } else if (attempts >= maxAttempts) {
      isGameOver = true;
      totalGames++;
      currentWinStreak = 0;
      saveStats();
      saveGameProgress();
      showEndGameModal(false);
      document.getElementById('guessButton').style.display = "none";
      document.getElementById('showResultsButton').style.display = "block";
    } else {
      // Save progress after each guess
      saveGameProgress();
    }
  } else {
    document.getElementById('result').innerHTML = "<p>Song not found or already guessed!</p>";
  }
  document.getElementById('guessInput').value = '';
  document.getElementById('guessInput').placeholder = `Attempts left: ${maxAttempts - attempts}`;
});

// Update showEndGameModal to ensure stats display is updated
function showEndGameModal(isWin) {
  const modalContent = document.getElementById('endGameContent');
  modalContent.innerHTML = originalModalContent;
  
  const marquee = modalContent.querySelector('.album-divider .marquee');
  if (marquee) {
    let imagesHTML = "";
    const numCopies = 30;
    for (let i = 0; i < numCopies; i++) {
      imagesHTML += `<img src="photo/${randomSong.album}" alt="Album Cover" style="width: 50px; height: auto;">`;
    }
    marquee.innerHTML = imagesHTML;
  }

  document.getElementById('donationContainer').style.display = "block";
  document.getElementById('finalFeatures').style.display = (randomSong.features === "None" ? "none" : "block");
  
  const endGameTitle = document.getElementById('endGameTitle');
  const finalSongName = document.getElementById('finalSongName');
  const finalFeatures = document.getElementById('finalFeatures');
  
  endGameTitle.textContent = isWin ? "You guessed it!" : "Game Over!";
  finalSongName.textContent = randomSong.song;
  if (randomSong.features !== "None") {
    finalFeatures.textContent = "ft. " + randomSong.features;
  }
  
  let timerElem = document.createElement('div');
  timerElem.id = "timerCountdown";
  timerElem.style.margin = "10px 0";
  const statsContainer = modalContent.querySelector('.stats-container');
  if (statsContainer) {
    modalContent.insertBefore(timerElem, statsContainer);
  }
  if (countdownInterval) clearInterval(countdownInterval);
  updateCountdown(timerElem);
  countdownInterval = setInterval(() => { updateCountdown(timerElem); }, 1000);

  updateAlbumCover();
  
  // Update all stats displays
  updateStatsDisplay();

  document.getElementById('guessInput').disabled = true;
  
  showModal('endGameModal');
}
    // Inicjalizacja statystyk
    let totalGames = 0;
    let totalCorrect = 0;
    let currentWinStreak = 0;
    let bestWinStreak = 0;
    loadStats();
    
    // Funkcje pomocnicze do odliczania
    function getCountdownString() {
      const now = new Date();
      const ref = new Date(2020, 0, 1, 0, 0, 0, 0);
      const periodMs = 12 * 60 * 60 * 1000;
      const diff = now - ref;
      const remainderMs = diff % periodMs;
      const remainingMs = periodMs - remainderMs;
      const totalSeconds = Math.floor(remainingMs / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }
    function pad(num) {
      return num.toString().padStart(2, '0');
    }
    let countdownInterval = null;
    function updateCountdown(elem) {
      if (elem) {
        elem.textContent = "Next song in: " + getCountdownString();
      }
    }
    
    const songsDatabase = [
      { song: "Rockstar Made", album: "wholelottared.jpg", trackNo: 1, trackLength: "3:13", features: "None" },
      { song: "Go2DaMoon", album: "wholelottared.jpg", trackNo: 2, trackLength: "1:59", features: "Kanye West" },
      { song: "Long Time", album: "dieeelittt.jpg", trackNo: 1, trackLength: "3:31", features: "None" },
      { song: "R.I.P.", album: "dieeelittt.jpg", trackNo: 2, trackLength: "3:12", features: "None" },
      { song: "Location", album: "selftitled.jpg", trackNo: 1, trackLength: "2:48", features: "None" },
      { song: "Magnolia", album: "selftitled.jpg", trackNo: 2, trackLength: "3:01", features: "None" }
    ];
    
    const albumReleaseYears = {
      "wholelottared.jpg": 2020,
      "dieeelittt.jpg": 2018,
      "selftitled.jpg": 2017
    };
    
    // Obliczanie piosenki (rotacja co 12 godzin)
    const now = new Date();
    const ref = new Date(2020, 0, 1, 0, 0, 0, 0);
    const diffHours = (now - ref) / (1000 * 60 * 60);
    const periodIndex = Math.floor(diffHours / 12);
    const songIndex = ((periodIndex % songsDatabase.length) + songsDatabase.length) % songsDatabase.length;
    let randomSong = songsDatabase[songIndex];
    
    let attempts = 0;
    const maxAttempts = 8;
    let guessedSongs = [];
    let isGameOver = false;
    
    function showSuggestions() {
      document.getElementById('result').innerHTML = "";
      const input = document.getElementById('guessInput').value.toLowerCase();
      const suggestionsList = document.getElementById('suggestionsList');
      suggestionsList.innerHTML = '';
      if (input.length > 0) {
        const filteredSongs = songsDatabase.filter(song =>
          song.song.toLowerCase().startsWith(input) && !guessedSongs.includes(song.song)
        );
        filteredSongs.forEach(song => {
          const suggestionItem = document.createElement('li');
          suggestionItem.textContent = song.song;
          suggestionItem.onclick = function() {
            document.getElementById('guessInput').value = song.song;
            suggestionsList.innerHTML = '';
          };
          suggestionsList.appendChild(suggestionItem);
        });
      }
    }
    
    document.getElementById('guessButton').addEventListener('click', () => {
      if (attempts >= maxAttempts || isGameOver) return;
      const userGuess = document.getElementById('guessInput').value.trim();
      const guessedSong = songsDatabase.find(song => song.song.toLowerCase() === userGuess.toLowerCase());
      if (guessedSong && !guessedSongs.includes(guessedSong.song)) {
        attempts++;
        guessedSongs.push(guessedSong.song);
    
        const newRow = document.createElement('tr');
        const songCell = document.createElement('td');
        const albumCell = document.createElement('td');
        const trackNoCell = document.createElement('td');
        const trackLengthCell = document.createElement('td');
        const featuresCell = document.createElement('td');
    
        songCell.textContent = guessedSong.song;
    
        const albumContainer = document.createElement('div');
        albumContainer.classList.add('album-container');
        albumContainer.style.width = '100%';
    
        const albumImg = document.createElement('img');
        albumImg.src = `photo/${guessedSong.album}`;
        albumImg.alt = guessedSong.album;
        albumImg.classList.add('album-image');
        albumImg.style.marginRight = "10px";
        albumContainer.appendChild(albumImg);
    
        if (guessedSong.album !== randomSong.album) {
          const arrowSpan = document.createElement('span');
          if (albumReleaseYears[guessedSong.album] < albumReleaseYears[randomSong.album]) {
            arrowSpan.classList.add('arrow-up');
          } else {
            arrowSpan.classList.add('arrow-down');
          }
          arrowSpan.style.width = "15px";
          arrowSpan.style.display = "inline-block";
          arrowSpan.style.textAlign = "right";
          albumContainer.appendChild(arrowSpan);
        }
    
        albumCell.appendChild(albumContainer);
        albumCell.classList.add('album-cell');
    
        trackNoCell.textContent = guessedSong.trackNo;
        trackLengthCell.textContent = guessedSong.trackLength;
        featuresCell.textContent = guessedSong.features;
    
        highlightCell(songCell, guessedSong.song === randomSong.song, true);
        highlightCell(albumCell, guessedSong.album === randomSong.album);
        highlightNumericCell(trackNoCell, guessedSong.trackNo, randomSong.trackNo);
        highlightTimeCell(trackLengthCell, guessedSong.trackLength, randomSong.trackLength);
        highlightCell(featuresCell, guessedSong.features === randomSong.features);
    
        newRow.appendChild(songCell);
        newRow.appendChild(albumCell);
        newRow.appendChild(trackNoCell);
        newRow.appendChild(trackLengthCell);
        newRow.appendChild(featuresCell);
    
        newRow.classList.add('fade-in');
        document.getElementById('guessesTable').appendChild(newRow);
    
        if (guessedSong.song === randomSong.song) {
          isGameOver = true;
          totalGames++;
          totalCorrect++;
          currentWinStreak++;
          if (currentWinStreak > bestWinStreak) {
            bestWinStreak = currentWinStreak;
          }
          saveStats();
          showEndGameModal(true);
          document.getElementById('guessButton').style.display = "none";
          document.getElementById('showResultsButton').style.display = "block";
        } else if (attempts >= maxAttempts) {
          isGameOver = true;
          totalGames++;
          currentWinStreak = 0;
          saveStats();
          showEndGameModal(false);
          document.getElementById('guessButton').style.display = "none";
          document.getElementById('showResultsButton').style.display = "block";
        }
      } else {
        document.getElementById('result').innerHTML = "<p>Song not found or already guessed!</p>";
      }
      document.getElementById('guessInput').value = '';
      document.getElementById('guessInput').placeholder = `Attempts left: ${maxAttempts - attempts}`;
    });
    
    function highlightCell(cell, isCorrect, isSong = false) {
      if (isCorrect) cell.classList.add('correct');
    }
    
    function highlightNumericCell(cell, guessValue, correctValue) {
      if (guessValue === correctValue) {
        cell.classList.add('correct');
      } else if (Math.abs(guessValue - correctValue) === 1) {
        cell.classList.add('neighbor');
        cell.classList.add(guessValue < correctValue ? 'arrow-up' : 'arrow-down');
      } else {
        cell.classList.add(guessValue < correctValue ? 'arrow-up' : 'arrow-down');
      }
    }
    
    function highlightTimeCell(cell, guessTime, correctTime) {
      const guessSeconds = convertToSeconds(guessTime);
      const correctSeconds = convertToSeconds(correctTime);
      if (guessTime === correctTime) {
        cell.classList.add('correct');
      } else if (Math.abs(guessSeconds - correctSeconds) <= 15) {
        cell.classList.add('neighbor');
        cell.classList.add(guessSeconds < correctSeconds ? 'arrow-up' : 'arrow-down');
      } else {
        cell.classList.add(guessSeconds < correctSeconds ? 'arrow-up' : 'arrow-down');
      }
    }
    
    function convertToSeconds(time) {
      const [minutes, seconds] = time.split(':').map(Number);
      return minutes * 60 + seconds;
    }
    
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      modal.style.opacity = 1;
    }
    
    document.getElementById('endGameModal').addEventListener('click', function(event) {
      const modalContent = this.querySelector('.modal-content');
      if (!modalContent.contains(event.target)) {
        this.style.opacity = 0;
        setTimeout(() => {
          this.style.display = 'none';
          this.style.opacity = 1;
        }, 500);
      }
    });
    
    // Modal końcowy – wyświetlanie statystyk i licznika
    function showEndGameModal(isWin) {
      const modalContent = document.getElementById('endGameContent');
      modalContent.innerHTML = originalModalContent;
      
      const marquee = modalContent.querySelector('.album-divider .marquee');
      if (marquee) {
        let imagesHTML = "";
        const numCopies = 30;
        for (let i = 0; i < numCopies; i++) {
          imagesHTML += `<img src="photo/${randomSong.album}" alt="Album Cover" style="width: 50px; height: auto;">`;
        }
        marquee.innerHTML = imagesHTML;
      }
    
      document.getElementById('donationContainer').style.display = "block";
      document.getElementById('finalFeatures').style.display = (randomSong.features === "None" ? "none" : "block");
      
      const endGameTitle = document.getElementById('endGameTitle');
      const finalSongName = document.getElementById('finalSongName');
      const finalFeatures = document.getElementById('finalFeatures');
      
      endGameTitle.textContent = isWin ? "You guessed it!" : "Game Over!";
      finalSongName.textContent = randomSong.song;
      if (randomSong.features !== "None") {
        finalFeatures.textContent = "ft. " + randomSong.features;
      }
      
      let timerElem = document.createElement('div');
      timerElem.id = "timerCountdown";
      timerElem.style.margin = "10px 0";
      const statsContainer = modalContent.querySelector('.stats-container');
      if (statsContainer) {
        modalContent.insertBefore(timerElem, statsContainer);
      }
      if (countdownInterval) clearInterval(countdownInterval);
      updateCountdown(timerElem);
      countdownInterval = setInterval(() => { updateCountdown(timerElem); }, 1000);
    
      updateAlbumCover();
      
      document.getElementById('winStreak').textContent = currentWinStreak;
      document.getElementById('correctGuesses').textContent = totalCorrect;
      document.getElementById('gamesPlayed').textContent = totalGames;
      document.getElementById('bestWinStreak').textContent = bestWinStreak;
    
      document.getElementById('guessInput').disabled = true;
      
      showModal('endGameModal');
    }
    
    // Modal statystyk – wyświetlanie statystyk gracza
    function showStatsModal() {
      const modalContent = document.getElementById('endGameContent');
      modalContent.innerHTML = originalModalContent;
      const albumCover = document.getElementById('albumCover');
      const endGameTitle = document.getElementById('endGameTitle');
      const finalSongName = document.getElementById('finalSongName');
      const statsContainer = modalContent.querySelector('.stats-container');
      const donationContainer = document.getElementById('donationContainer');
      const finalFeatures = document.getElementById('finalFeatures');
      
      donationContainer.style.display = "none";
      finalFeatures.style.display = "none";
      
      modalContent.innerHTML = "";
      modalContent.appendChild(finalSongName);
      modalContent.appendChild(albumCover);
      let timerElem = document.createElement('div');
      timerElem.id = "timerCountdown";
      timerElem.style.margin = "10px 0";
      modalContent.appendChild(timerElem);
      modalContent.appendChild(endGameTitle);
      modalContent.appendChild(statsContainer);
    
      finalSongName.textContent = "Guessed Song: " + randomSong.song;
      endGameTitle.textContent = "Your Stats";
      updateAlbumCover();
      
      document.getElementById('winStreak').textContent = currentWinStreak;
      document.getElementById('correctGuesses').textContent = totalCorrect;
      document.getElementById('gamesPlayed').textContent = totalGames;
      document.getElementById('bestWinStreak').textContent = bestWinStreak;
    
      document.getElementById('guessInput').disabled = true;
    
      if (countdownInterval) clearInterval(countdownInterval);
      updateCountdown(timerElem);
      countdownInterval = setInterval(() => { updateCountdown(timerElem); }, 1000);
    
      showModal('endGameModal');
    }
    
    document.getElementById('supportUsButton').addEventListener('click', () => {
      window.open("https://some-donation-link.example", "_blank");
    });
    
    document.getElementById('showResultsButton').addEventListener('click', showStatsModal);
    
    // Zapamiętujemy oryginalną zawartość modala endGame
    const originalModalContent = document.getElementById('endGameContent').innerHTML;
    
    function updateAlbumCover() {
      const albumCover = document.getElementById('albumCover');
      albumCover.src = `photo/${randomSong.album}`;
      albumCover.style.display = "block";
    }
    
    // TRANSICJA MIĘDZY MODALAMI: z welcomeModal do instructionsModal
    function transitionToInstructions() {
      const welcomeModal = document.getElementById('welcomeModal');
      const instructionsModal = document.getElementById('instructionsModal');
      welcomeModal.style.opacity = 0;
      setTimeout(() => {
        welcomeModal.style.display = 'none';
        instructionsModal.style.display = 'flex';
        instructionsModal.style.opacity = 0;
        void instructionsModal.offsetWidth;
        instructionsModal.style.transition = 'opacity 0.5s ease-out';
        instructionsModal.style.opacity = 1;
        // Ustawiamy ciasteczko, aby modale nie pokazywały się przy kolejnych wejściach
        setCookie("modalsShown", "true", 365);
      }, 500);
    }
    
    document.getElementById('welcomeModal').addEventListener('click', transitionToInstructions);
    
    document.getElementById('instructionsModal').addEventListener('click', function(event) {
      const modalContent = this.querySelector('.modal-content');
      if (!modalContent.contains(event.target)) {
        this.style.opacity = 0;
        setTimeout(() => {
          this.style.display = 'none';
          this.style.opacity = 1;
        }, 500);
      }
    });
    // Po załadowaniu DOM, podpina zdarzenia kliknięcia do ikonek
document.addEventListener('DOMContentLoaded', function() {
  // Ikonka otwierająca modal instrukcji
  const infoIcon = document.getElementById('infoIcon');
  infoIcon.addEventListener('click', function() {
    openInstructionsModal();
  });

  // Ikonka otwierająca nowy modal "donate"
  const donateIcon = document.getElementById('donateIcon');
  donateIcon.addEventListener('click', function() {
    openDonateModal();
  });
});

// Funkcja otwierająca modal instrukcji
function openInstructionsModal() {
  const instructionsModal = document.getElementById('instructionsModal');
  instructionsModal.style.display = 'flex';
  instructionsModal.style.opacity = 1;
}

// Funkcja otwierająca modal donate
function openDonateModal() {
  const donateModal = document.getElementById('donateModal');
  donateModal.style.display = 'flex';
  donateModal.style.opacity = 1;
}
document.getElementById('donateModal').addEventListener('click', function(event) {
  const modalContent = this.querySelector('.modal-content');
  if (!modalContent.contains(event.target)) {
    // Kliknięto poza kontentem modala, zamykamy z animacją
    this.style.opacity = 0;
    setTimeout(() => {
      this.style.display = 'none';
      this.style.opacity = 1;
    }, 500);
  }
});

  </script>
</body>
</html>
